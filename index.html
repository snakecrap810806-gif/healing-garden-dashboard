<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>디지털 치유정원·실시간 정원 환경 대시보드</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f7fbfd;
    --card:#ffffff;
    --text:#102a43;
    --muted:#6b7c93;
    --good:#14b97a;
    --warn:#f59f00;
    --bad:#e03131;
    --shadow:0 8px 28px rgba(16,42,67,.08);
    --ring:0 0 0 8px rgba(20,185,122,.15);
    --accent:#0ea5e9;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Pretendard",system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-tap-highlight-color:transparent;
    touch-action:manipulation; /* 모바일 탭 지연/제스처 최소화 */
  }
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  header{
    display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:16px;
  }
  .title{
    font-size:clamp(20px,3.6vw,40px); font-weight:800; letter-spacing:-.02em;
  }
  .meta{
    font-size:14px; color:var(--muted);
  }
  .toolbar{display:flex; gap:8px; align-items:center}
  .btn{
    border:0; background:#e6f6ff; color:var(--accent); font-weight:700;
    padding:10px 14px; border-radius:10px; cursor:pointer;
  }
  .grid{
    display:grid; gap:18px; grid-template-columns:repeat(12,1fr);
  }
  .card{
    grid-column:span 12;
    background:var(--card); border-radius:18px; padding:18px 18px 14px;
    box-shadow:var(--shadow);
    display:flex; align-items:center; justify-content:space-between; cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .card:active{transform:translateY(1px)}
  .card:focus-visible{outline:none; box-shadow:var(--shadow), var(--ring)}
  @media(min-width:640px){ .card{grid-column:span 6} }
  @media(min-width:980px){ .card{grid-column:span 3} }
  .left{display:flex; gap:12px; align-items:center}
  .icon{
    width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
    background:#f2f7fb;font-size:22px
  }
  .label{font-weight:800; letter-spacing:-.02em}
  .value{font-size:28px; font-weight:800}
  .unit{margin-left:4px; font-size:14px; color:var(--muted); font-weight:700}
  .state{
    padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px;
  }
  .good{background:rgba(20,185,122,.12); color:var(--good)}
  .warn{background:rgba(245,159,0,.14); color:var(--warn)}
  .bad{ background:rgba(224,49,49,.14); color:var(--bad) }
  /* summary bar */
  .summary{
    margin-top:14px; background:var(--card); border-radius:16px;
    padding:12px 16px; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px;
  }
  .dot{width:10px;height:10px;border-radius:999px;background:var(--good)}
  /* modal */
  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,.4);
    display:none; align-items:flex-end; justify-content:center; z-index:50;
  }
  .sheet{
    width:min(1080px,94vw); height:64vh; background:var(--card);
    border-radius:22px 22px 0 0; box-shadow:0 -8px 30px rgba(0,0,0,.12);
    padding:14px 14px 10px; display:flex; flex-direction:column; gap:8px;
  }
  .sheet-head{display:flex; justify-content:space-between; align-items:center}
  .sheet-title{font-weight:800; letter-spacing:-.02em}
  .close{border:0;background:#f0f3f7;border-radius:10px;padding:8px 12px;cursor:pointer}
  .chartbox{position:relative; flex:1; min-height:48vh}
  canvas{position:absolute; inset:8px; width:calc(100% - 16px)!important; height:calc(100% - 16px)!important}
  /* helps iframe hosts like MP Skin */
  .clickable{pointer-events:auto}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">디지털 치유정원·실시간 정원 환경 대시보드</div>
        <div id="clock" class="meta">--</div>
      </div>
      <div class="toolbar">
        <button id="refreshBtn" class="btn">지금 새로고침</button>
      </div>
    </header>

    <main class="grid clickable" id="cards">
      <!-- 카드들이 JS로 렌더링됩니다 -->
    </main>

    <section class="summary clickable" aria-live="polite">
      <span class="dot" id="dot"></span>
      <strong id="summary">종합 평가: 계산 중...</strong>
    </section>
  </div>

  <!-- 모달 -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="sheet">
      <div class="sheet-head">
        <div class="sheet-title" id="modalTitle">시간대 그래프</div>
        <button class="close" id="closeModal">닫기</button>
      </div>
      <div class="chartbox">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   데이터/상태 로직
----------------------------- */
const THRESHOLDS = {
  PM10: 100,      // ㎍/㎥
  PM25: 50,       // ㎍/㎥
  CO2:  1000      // ppm
};

const UNITS = { PM10:'㎍/㎥', PM25:'㎍/㎥', CO2:'ppm', TEMP:'℃', HUM:'%RH' };
const LABELS = { PM10:'PM10', PM25:'PM2.5', CO2:'CO₂', TEMP:'온도', HUM:'습도' };
const ICONS  = { PM10:'☁️', PM25:'🏙️', CO2:'🫁', TEMP:'🌡️', HUM:'💧' };

// 시작 값(가을 느낌)
let cur = { PM10: 28, PM25: 15, CO2: 520, TEMP: 18.5, HUM: 55 };

const historyMap = {
  PM10:[], PM25:[], CO2:[], TEMP:[], HUM:[]
};
const MAX_POINTS = 60; // 약 한 시간치(분 단위라 가정)

/* 작은 변화 + 드문 스파이크 */
function nextValue(key, now){
  const v = cur[key];
  let delta = 0;
  switch(key){
    case 'PM10': delta = rand(-1.2, 1.4); break;
    case 'PM25': delta = rand(-0.8, 1.0); break;
    case 'CO2' : delta = rand(-10, 14); break;
    case 'TEMP': delta = rand(-0.05, 0.06); break;
    case 'HUM' : delta = rand(-0.6, 0.8); break;
  }
  let spikeChance = 0.05; // 5%만 경고 스파이크
  let val = v + delta;
  if(Math.random() < spikeChance){
    if(key==='PM10') val += rand(25, 45);
    if(key==='PM25') val += rand(12, 25);
    if(key==='CO2')  val += rand(120, 260);
  }
  // 안전 클램프
  if(key==='PM10') val = clamp(val, 8, 135);
  if(key==='PM25') val = clamp(val, 5, 80);
  if(key==='CO2')  val = clamp(val, 380, 1400);
  if(key==='TEMP') val = clamp(val, 10, 28);
  if(key==='HUM')  val = clamp(val, 30, 85);
  cur[key] = round(val, (key==='TEMP')?1:1);
  pushHistory(key, now, cur[key]);
}

function pushHistory(key, now, value){
  const arr = historyMap[key];
  arr.push({ t: now, v: value });
  if(arr.length > MAX_POINTS) arr.shift();
}

function stateOf(key, value){
  if(key==='CO2'){
    if(value <= THRESHOLDS.CO2) return { cls:'good', txt:'좋음' };
    else return { cls:'bad', txt:'위험' };
  }else if(key==='PM10'){
    if(value <= THRESHOLDS.PM10) return { cls:'good', txt:'좋음' };
    else return { cls:'bad', txt:'위험' };
  }else if(key==='PM25'){
    if(value <= THRESHOLDS.PM25) return { cls:'good', txt:'좋음' };
    else return { cls:'bad', txt:'위험' };
  }else{
    // TEMP/HUM 상태는 참고용(항상 '좋음')
    return { cls:'good', txt:'양호' };
  }
}

function summaryText(){
  const s = ['PM10','PM25','CO2'].map(k=>stateOf(k,cur[k]).cls);
  const badCnt = s.filter(x=>x==='bad').length;
  if(badCnt===0) return { text:'종합 평가: 쾌적', color:'var(--good)' };
  if(badCnt===1) return { text:'종합 평가: 보통', color:'var(--warn)' };
  return { text:'종합 평가: 주의', color:'var(--bad)' };
}

/* -----------------------------
   렌더링
----------------------------- */
const cardsEl = document.getElementById('cards');
const clockEl = document.getElementById('clock');
const dotEl = document.getElementById('dot');
const sumEl = document.getElementById('summary');

const FIELDS = ['PM10','PM25','CO2','TEMP','HUM'];

function renderCards(){
  cardsEl.innerHTML = '';
  FIELDS.forEach(key=>{
    const val = cur[key];
    const st  = stateOf(key,val);
    const card = document.createElement('button');
    card.className='card';
    card.setAttribute('type','button');
    card.setAttribute('data-key',key);
    card.innerHTML = `
      <div class="left">
        <div class="icon">${ICONS[key]}</div>
        <div>
          <div class="label">${LABELS[key]}</div>
          <div class="value">${val}<span class="unit">${UNITS[key]||''}</span></div>
        </div>
      </div>
      <div class="state ${st.cls}">${st.txt}</div>
    `;
    // 클릭 + 터치 지원
    bindTap(card, () => openChart(key));
    cardsEl.appendChild(card);
  });
}

function renderClock(){
  const now = new Date();
  const fmt = now.toLocaleString('ko-KR', { year:'numeric', month:'numeric', day:'numeric', hour:'numeric', minute:'2-digit', second:'2-digit' });
  clockEl.textContent = `${fmt} · 30초 간격 업데이트`;
}

function renderSummary(){
  const s = summaryText();
  sumEl.textContent = s.text;
  dotEl.style.background = s.color;
}

/* -----------------------------
   차트 모달
----------------------------- */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const closeBtn = document.getElementById('closeModal');
let chart;

function openChart(key){
  // PM10/PM2.5/CO2만 그래프 (TEMP/HUM은 선택적)
  modal.style.display='flex';
  modalTitle.textContent = `${LABELS[key]} 시간대별 측정값`;
  if(chart){ chart.destroy(); chart=null; }
  const ctx = document.getElementById('chart').getContext('2d');
  const labels = historyMap[key].map(p=>new Date(p.t).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}));
  const data   = historyMap[key].map(p=>p.v);

  // 완만한 곡선을 위해 y축 여유폭 크게
  const maxY = Math.max(...data, (key==='PM10')?140:(key==='PM25')?80:(key==='CO2')?1400:100);
  chart = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{
      label:`${LABELS[key]} 시간대별 측정값`,
      data,
      fill:true,
      borderColor:'#10a6d1',
      backgroundColor:'rgba(16,166,209,.12)',
      tension:.35,
      pointRadius:2
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ intersect:false, mode:'index' },
      scales:{
        y:{
          suggestedMin:0,
          suggestedMax:maxY,
          ticks:{ font:{ weight:700 } }
        },
        x:{ ticks:{ maxRotation:0, autoSkip:true, font:{ weight:700 } } }
      },
      plugins:{ legend:{ display:false } }
    }
  });
}
function closeChart(){ modal.style.display='none'; }
bindTap(closeBtn, closeChart);
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeChart(); });

/* -----------------------------
   주기 업데이트
----------------------------- */
function tick(){
  const now = Date.now();
  FIELDS.forEach(k => nextValue(k, now));
  renderCards(); renderClock(); renderSummary();
}
document.getElementById('refreshBtn').addEventListener('click', ()=>{ tick(); });

/* 초기가입력 - 히스토리 채우기 */
(function seed(){
  const baseNow = Date.now() - MAX_POINTS*60000; // 1분 간격 가정
  for(let i=0;i<MAX_POINTS;i++){
    const t = baseNow + i*60000;
    FIELDS.forEach(k=>{
      // 아주 작은 변동으로 시드
      const jitter = (k==='TEMP')? rand(-.08,.08) : (k==='HUM')? rand(-.5,.5) : rand(-1,1);
      const v = (cur[k]+jitter);
      historyMap[k].push({ t, v });
    });
  }
  // 시드 후 한 번 렌더
  renderCards(); renderClock(); renderSummary();
})();

// 30초마다
setInterval(tick, 30000);

/* -----------------------------
   유틸
----------------------------- */
function rand(min,max){ return Math.random()*(max-min)+min; }
function clamp(n,min,max){ return Math.min(max, Math.max(min,n)); }
function round(n, d=1){ const f=Math.pow(10,d); return Math.round(n*f)/f; }

// 모바일 탭/클릭 동시지원(이중 호출 방지)
function bindTap(el, fn){
  let locked = false;
  const handler = (e)=>{ 
    if(locked) return;
    locked = true;
    fn();
    setTimeout(()=>locked=false, 300);
  };
  el.addEventListener('click', handler);
  el.addEventListener('touchend', (e)=>{ e.preventDefault(); handler(e); }, {passive:false});
}
</script>
</body>
</html>
