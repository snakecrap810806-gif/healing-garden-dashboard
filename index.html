<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>디지털 치유정원·실시간 정원 환경 대시보드</title>

  <!-- Pretendard/Noto 대체용 시스템 폰트 스택 -->
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e6eef6;
      --good:#16a34a; --warn:#a16207; --bad:#991b1b;
      --goodBg:#ecfdf5; --warnBg:#fffbeb; --badBg:#fef2f2;
      --cardShadow:0 14px 40px rgba(15,23,42,.08);
      --box: #fff;
      --accent:#1e90ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,PingFang SC,Helvetica,Arial;
      background: radial-gradient(1200px 600px at 80% -20%, #f0f7ff 0%, transparent 60%) #f7fbff;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:1200px; margin:28px auto; padding:0 16px}
    .title{font-size:clamp(24px,3.6vw,44px); font-weight:900; letter-spacing:-0.02em; margin:10px 0 6px}
    .subtitle{color:var(--muted); font-weight:600; display:flex; gap:10px; align-items:center}
    .subtitle .btn{margin-left:auto}
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff; color:#0f172a;
      font-weight:800; padding:10px 14px; border-radius:999px; cursor:pointer;
      box-shadow:0 4px 14px rgba(2,6,23,.06);
    }
    .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:18px; margin-top:16px}
    @media (max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }

    /* 카드 = 아이콘 -> 라벨 -> 값 -> 상태 */
    .card{
      background:var(--box); border:none; border-radius:20px; box-shadow:var(--cardShadow);
      padding:26px 22px; display:flex; flex-direction:column; align-items:center; text-align:center;
      cursor:pointer; user-select:none; touch-action:manipulation;
      transition:transform .12s ease;
    }
    .card:active{transform:scale(.98)}
    .icon{
      width:64px; height:64px; border-radius:16px; display:grid; place-items:center; font-size:30px;
      background:linear-gradient(135deg,#f2f8ff,#f2fffb);
      box-shadow:0 6px 18px rgba(2,6,23,.06) inset;
      color:#334155;
    }
    .label{margin-top:10px; font-weight:800; color:#617089; letter-spacing:-0.01em}
    .value{margin-top:8px; font-size:42px; font-weight:900; letter-spacing:-0.02em}
    .unit{margin-left:6px; color:#7d8aa6; font-weight:800}
    .pill{
      margin-top:12px; font-size:14px; font-weight:900; padding:7px 12px; border-radius:999px;
      border:1px solid var(--line); background:#fff; color:#4b5563;
    }
    .pill.good{background:var(--goodBg); border-color:#a7f3d0; color:#166534}
    .pill.warn{background:var(--warnBg); border-color:#fde68a; color:#a16207}
    .pill.bad {background:var(--badBg);  border-color:#fecaca; color:#991b1b}

    .foot{
      margin-top:22px; border-radius:16px; padding:14px 16px; background:#ffffffd9;
      border:1px solid var(--line); box-shadow:0 10px 26px rgba(2,6,23,.06);
      display:flex; align-items:center; gap:10px; font-weight:800;
    }
    .dot{width:10px; height:10px; border-radius:50%; background:var(--good)}

    /* 모달(그래프) */
    .backdrop{
      position:fixed; inset:0; background:rgba(15,23,42,.42);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:1000;
    }
    .sheet{
      width:min(1100px,96vw); background:#fff; border-radius:22px; border:1px solid var(--line);
      box-shadow:0 30px 90px rgba(2,6,23,.28); padding:16px 16px 18px;
    }
    .sheet-head{display:flex; align-items:center; gap:8px; margin-bottom:8px}
    .sheet-title{font-weight:900}
    .sheet-close{margin-left:auto}
    .sheet canvas{background:#fbfeff; border:1px solid var(--line); border-radius:12px; width:100% !important; height:340px !important}
    @media (max-width:640px){ .sheet canvas{height:300px !important} }
  </style>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
</head>
<body>
  <div class="wrap">
    <div class="title">디지털 치유정원·실시간 정원 환경 대시보드</div>
    <div class="subtitle">
      <span id="clock">--</span>
      · <span>30초 간격 업데이트</span>
      <button id="refresh" class="btn">지금 새로고침</button>
    </div>

    <!-- 카드 5종 -->
    <div class="grid">
      <div class="card" data-key="pm10">
        <div class="icon">☁️</div>
        <div class="label">PM10</div>
        <div class="value"><span id="pm10v">--</span><span class="unit">µg/m³</span></div>
        <div class="pill" id="pm10s">--</div>
      </div>

      <div class="card" data-key="pm25">
        <div class="icon">🏙️</div>
        <div class="label">PM2.5</div>
        <div class="value"><span id="pm25v">--</span><span class="unit">µg/m³</span></div>
        <div class="pill" id="pm25s">--</div>
      </div>

      <div class="card" data-key="co2">
        <div class="icon">🫁</div>
        <div class="label">CO₂</div>
        <div class="value"><span id="co2v">--</span><span class="unit">ppm</span></div>
        <div class="pill" id="co2s">--</div>
      </div>

      <div class="card" data-key="temp">
        <div class="icon">🌡️</div>
        <div class="label">온도</div>
        <div class="value"><span id="tempv">--</span><span class="unit">℃</span></div>
        <div class="pill" id="temps">--</div>
      </div>

      <div class="card" data-key="humi">
        <div class="icon">💧</div>
        <div class="label">습도</div>
        <div class="value"><span id="humiv">--</span><span class="unit">%RH</span></div>
        <div class="pill" id="humis">--</div>
      </div>
    </div>

    <!-- 종합 평가 -->
    <div class="foot">
      <span class="dot" id="dot"></span>
      <span id="summary">종합 평가: 계산 중…</span>
    </div>
  </div>

  <!-- 그래프 모달 -->
  <div class="backdrop" id="modal">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-head">
        <div class="sheet-title" id="mtitle">그래프</div>
        <button class="btn sheet-close" id="close">닫기</button>
      </div>
      <canvas id="mchart"></canvas>
    </div>
  </div>

<script>
/* ---------------- 기본 가상 센서 파라미터(매우 작은 변동) ---------------- */
const base = { pm10: 35, pm25: 18, co2: 520, temp: 18.5, humi: 55 };
const bounds = {
  pm10:[12,60], pm25:[8,40], co2:[400,700], temp:[15,22], humi:[40,70]
};
const limit = { pm10:100, pm25:50, co2:1000 }; // 기준치

// Random walk(작은 폭), 10분에 1번 정도만 경고치 근접
let tick = 0;
function jitter(v,step=0.6){        // 변동폭 작게
  const n = v + (Math.random()-0.5)*step;
  return n;
}
function clamp(v,[min,max]){ return Math.max(min, Math.min(max, v)); }
function stepData(){
  tick++;
  // 가끔 살짝 더 오르내리기(10분 1회 정도)
  const pulse = (tick % 20 === 0) ? 1.4 : 1.0;

  base.pm10 = clamp(jitter(base.pm10, 0.8)*pulse, bounds.pm10);
  base.pm25 = clamp(jitter(base.pm25, 0.5)*pulse, bounds.pm25);
  base.co2  = clamp(jitter(base.co2 , 6  )*pulse, bounds.co2);
  base.temp = clamp(jitter(base.temp, 0.15), bounds.temp);
  base.humi = clamp(jitter(base.humi, 0.6 ), bounds.humi);
}

// 상태 판정
function state(key,val){
  if(key==='pm10') return val<=limit.pm10?'good':'bad';
  if(key==='pm25') return val<=limit.pm25?'good':'bad';
  if(key==='co2')  return val<=limit.co2 ?'good':'bad';
  if(key==='temp') return (val>=17 && val<=27)?'good':'warn';
  if(key==='humi') return (val>=40 && val<=65)?'good':'warn';
  return 'good';
}
function stateText(s){ return s==='good'?'좋음':(s==='warn'?'양호':'위험'); }

// 렌더
function renderCards(){
  const v = (id,val)=> document.getElementById(id).textContent = String(val);
  v('pm10v', Math.round(base.pm10));
  v('pm25v', Math.round(base.pm25));
  v('co2v',  Math.round(base.co2));
  v('tempv', base.temp.toFixed(1));
  v('humiv', Math.round(base.humi));

  ['pm10','pm25','co2','temp','humi'].forEach(k=>{
    const s = state(k, base[k]);
    const el = document.getElementById(k+'s');
    el.className='pill '+s; el.textContent=stateText(s);
  });

  // 종합(하나라도 위험이면 위험, 아니면 양호/좋음)
  const keys=['pm10','pm25','co2','temp','humi'];
  const flags = keys.map(k=>state(k,base[k]));
  let sumText='쾌적';
  let dot='#16a34a';
  if(flags.includes('bad')){ sumText='주의(위험)'; dot='#dc2626'; }
  else if(flags.includes('warn')){ sumText='양호'; dot='#ca8a04'; }
  document.getElementById('summary').textContent = '종합 평가: ' + sumText;
  document.getElementById('dot').style.background = dot;
}

// 시계 + 주기 업데이트
function clock(){ document.getElementById('clock').textContent =
  new Date().toLocaleString('ko-KR', {year:'numeric', month:'numeric', day:'numeric',
    hour:'numeric', minute:'2-digit', second:'2-digit'}) + ' 기준'; }

function tickAll(){
  stepData(); renderCards(); clock();
}
setInterval(()=>{ tickAll(); pushHistory(); }, 30000);

// 초기화
tickAll();
document.getElementById('refresh').addEventListener('click', ()=>{ tickAll(); pushHistory(); });

/* ---------------- 그래프(카드 클릭→모달) ---------------- */
const modal = document.getElementById('modal');
const closeBtn = document.getElementById('close');
let chart;
const history = { pm10:[], pm25:[], co2:[], temp:[], humi:[], labels:[] };

function pushHistory(){
  const t = new Date();
  const label = t.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  history.labels.push(label);
  ['pm10','pm25','co2','temp','humi'].forEach(k=> history[k].push(Math.round(base[k]*10)/10));
  // 최대 24개(약 12시간) 보이도록
  const cap = 24;
  if(history.labels.length>cap){ history.labels.shift(); ['pm10','pm25','co2','temp','humi'].forEach(k=>history[k].shift()); }
}
pushHistory(); // 첫 점

function openChart(key){
  const names = {pm10:'PM10(µg/m³)', pm25:'PM2.5(µg/m³)', co2:'CO₂(ppm)', temp:'온도(℃)', humi:'습도(%RH)'};
  document.getElementById('mtitle').textContent = names[key] + ' 시간추이';
  modal.style.display='flex';

  const ctx = document.getElementById('mchart').getContext('2d');
  if(chart){ chart.destroy(); }
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels: history.labels,
      datasets:[{
        label: names[key],
        data: history[key],
        borderColor:'#22a6b3',
        backgroundColor:'rgba(34,166,179,.16)',
        tension:.25, fill:true, pointRadius:2
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:'nearest', intersect:false },
      plugins:{ legend:{display:true, labels:{boxWidth:10}} },
      scales:{
        x:{ grid:{color:'rgba(2,6,23,.06)'}, ticks:{ color:'#475569', maxRotation:0, autoSkip:true }},
        y:{ grid:{color:'rgba(2,6,23,.06)'}, ticks:{ color:'#334155' } }
      }
    }
  });
}
closeBtn.onclick=()=> modal.style.display='none';
modal.addEventListener('click',e=>{ if(e.target===modal) modal.style.display='none'; });

// 카드 클릭
document.querySelectorAll('.card').forEach(c=>{
  c.addEventListener('click', ()=> openChart(c.dataset.key), {passive:true});
});

// 모바일 터치 전달 강화(iframe 환경 대비)
document.body.style.touchAction='manipulation';
</script>
</body>
</html>
