<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>디지털 치유정원 · 실시간 정원 환경 대시보드</title>

<!-- 폰트(가독성↑) -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#f6faf9;
    --panel:#ffffff;
    --text:#1f2a37;
    --muted:#6b7280;
    --good:#089981;
    --bad:#ef4444;
    --accent:#0ea5e9;
    --ring: rgba(14,165,233,.15);
    --shadow: 0 10px 30px rgba(15,23,42,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Noto Sans KR", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    color:var(--text);
    background: var(--bg);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* 상단 헤더 */
  .wrap{max-width:1200px;margin:0 auto;padding:28px 18px 54px}
  .top{
    display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap;
    margin-bottom:8px;
  }
  .title{
    font-size:clamp(22px,3.2vw,36px);
    font-weight:800; letter-spacing:-.4px;
  }
  .ts{
    color:var(--muted); font-weight:600; font-size:14px;
  }

  /* 로고(원하시면 src만 교체) */
  .logos{display:flex;align-items:center;gap:22px}
  .logos img{height:28px;object-fit:contain;filter:drop-shadow(0 2px 2px rgba(0,0,0,.05))}
  /* ↑ 깃허브에 로고 PNG를 올리신 뒤 ./assets/파일명.png 식으로 교체하세요 */

  /* 카드들 */
  .grid{
    display:grid;grid-template-columns:repeat(3,1fr);
    gap:16px;margin-top:18px;
  }
  @media(max-width:920px){ .grid{grid-template-columns:1fr} }

  .card{
    background:var(--panel); border-radius:20px; box-shadow:var(--shadow);
    padding:18px 18px 16px; position:relative; overflow:hidden;
    transition:transform .2s ease, box-shadow .2s ease;
    border:1px solid rgba(2,6,23,.04);
  }
  .card:focus-within, .card:hover{
    box-shadow:0 14px 36px rgba(2,6,23,.10);
    transform:translateY(-2px);
  }
  .head{display:flex; align-items:center; justify-content:space-between}
  .label{font-weight:800; letter-spacing:-.3px}
  .badge{
    font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px;
    background:var(--ring); color:var(--accent);
  }
  .value{
    display:flex; align-items:baseline; gap:8px; margin-top:10px
  }
  .v{
    font-size:clamp(28px,4.2vw,40px); font-weight:800; letter-spacing:-.4px
  }
  .unit{color:var(--muted); font-weight:700}
  .state{margin-top:8px; font-weight:800; font-size:14px}
  .state.good{color:var(--good)} .state.bad{color:var(--bad)}

  .open-graph{
    margin-top:14px; width:100%;
    border:0; border-radius:12px; padding:12px 14px;
    font-weight:800; background:#eef6ff; color:#0369a1;
    cursor:pointer
  }
  .open-graph:active{transform:translateY(1px)}

  /* 모달 */
  .modal{
    position:fixed; inset:0; display:none; place-items:center;
    background:rgba(2,6,23,.5); z-index:50; padding:20px;
  }
  .modal.show{display:grid}
  .modal-panel{
    background:var(--panel); border-radius:18px; width:min(100%, 1100px);
    height:min(74vh, 620px); box-shadow:var(--shadow); position:relative;
    padding:16px 16px 12px;
  }
  .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .modal-title{font-weight:800}
  .close{
    border:0;background:#f1f5f9;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer
  }

  /* 차트 캔버스 - 모바일 터치/탭 최적화 */
  canvas{touch-action: manipulation; -webkit-tap-highlight-color: transparent;}

  /* 하단 컨트롤 */
  .bottom{
    margin-top:22px; display:flex; gap:10px; align-items:center; flex-wrap:wrap
  }
  .pill{border:0;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  .pill.secondary{background:#0ea5e9}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">디지털 치유정원 · 실시간 정원 환경 대시보드</div>
        <div class="ts"><span id="now"></span> · <b>30초 간격 업데이트</b></div>
      </div>
      <div class="logos">
        <!-- 필요시 src 교체(깃허브에 이미지 올린 뒤 상대경로 사용) -->
        <img src="" alt="국립정원문화원 로고(선택사항)" onerror="this.style.display='none'">
        <img src="" alt="두나무 로고(선택사항)" onerror="this.style.display='none'">
        <img src="" alt="Upbit 로고(선택사항)" onerror="this.style.display='none'">
      </div>
    </div>

    <div class="grid">
      <!-- PM10 -->
      <section class="card" id="card-pm10">
        <div class="head">
          <div class="label">PM10</div>
          <div class="badge">기준 ≤ 100 ㎍/㎥</div>
        </div>
        <div class="value">
          <div class="v" id="v-pm10">--</div><div class="unit">㎍/㎥</div>
        </div>
        <div class="state" id="s-pm10">--</div>
        <button class="open-graph" data-key="pm10">시간별 그래프 보기</button>
      </section>

      <!-- PM2.5 -->
      <section class="card" id="card-pm25">
        <div class="head">
          <div class="label">PM2.5</div>
          <div class="badge">기준 ≤ 50 ㎍/㎥</div>
        </div>
        <div class="value">
          <div class="v" id="v-pm25">--</div><div class="unit">㎍/㎥</div>
        </div>
        <div class="state" id="s-pm25">--</div>
        <button class="open-graph" data-key="pm25">시간별 그래프 보기</button>
      </section>

      <!-- CO₂ -->
      <section class="card" id="card-co2">
        <div class="head">
          <div class="label">CO₂</div>
          <div class="badge">기준 ≤ 1,000 ppm</div>
        </div>
        <div class="value">
          <div class="v" id="v-co2">--</div><div class="unit">ppm</div>
        </div>
        <div class="state" id="s-co2">--</div>
        <button class="open-graph" data-key="co2">시간별 그래프 보기</button>
      </section>
    </div>

    <div class="bottom">
      <button id="btn-refresh" class="pill secondary">지금 새로고침</button>
      <button id="btn-graph-all" class="pill">전체 그래프</button>
    </div>
  </div>

  <!-- 모달(단일) -->
  <div class="modal" id="modal">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="modal-title" id="modal-title">그래프</div>
        <button class="close" id="btn-close">닫기</button>
      </div>
      <div style="position:relative; width:100%; height:calc(100% - 40px)">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

<script>
/* ------------------------------ 시간 표시 ------------------------------ */
function tickTime(){
  const el = document.getElementById('now');
  const now = new Date();
  const f = d => d.toString().padStart(2,'0');
  el.textContent = `${now.getFullYear()}. ${now.getMonth()+1}. ${now.getDate()}. ${["일","월","화","수","목","금","토"][now.getDay()]} ${now.getHours()}:${f(now.getMinutes())}:${f(now.getSeconds())}`;
}
tickTime(); setInterval(tickTime, 1000);

/* ------------------------------ 데이터 모델 ------------------------------ */
/* 기준: PM10 ≤100, PM2.5 ≤50, CO2 ≤1000 */
const thresholds = { pm10:100, pm25:50, co2:1000 };

/* 초기값(가을철 실내/외 평균 느낌, 너무 급변하지 않게) */
let cur = {
  pm10: 30 + Math.random()*10,    // 30~40
  pm25: 12 + Math.random()*6,     // 12~18
  co2 : 430 + Math.random()*80    // 430~510
};

/* 히스토리 60포인트(최근 30분 가정: 30초 * 60) */
const MAX = 60;
const hist = {
  pm10: Array.from({length:MAX}, ()=> cur.pm10 + (Math.random()*2-1)*2 ),
  pm25: Array.from({length:MAX}, ()=> cur.pm25 + (Math.random()*2-1)*1.2 ),
  co2 : Array.from({length:MAX}, ()=> cur.co2  + (Math.random()*2-1)*8 )
};
const labels = Array.from({length:MAX}, (_,i)=>timeLabel(-MAX+1+i));

function timeLabel(offset){
  const t = new Date(Date.now() + offset*30*1000);
  const two = n => n.toString().padStart(2,'0');
  return `${two(t.getHours())}:${two(t.getMinutes())}`;
}

/* 30초마다 아주 작은 변동(약간의 노이즈) + 낮은 확률(3%)로 살짝 스파이크 */
const RISK_PROB=0.03;
function nextValue(key, base, noise, spike){
  let v = cur[key] + (Math.random()*2-1)*noise;
  if(Math.random()<RISK_PROB){ v += spike * (Math.random()<0.5 ? 1 : -1); }
  v = Math.max(v, 0);
  cur[key] = v;
  return v;
}

/* ------------------------------ UI 바인딩 ------------------------------ */
const elV = {
  pm10: document.getElementById('v-pm10'),
  pm25: document.getElementById('v-pm25'),
  co2 : document.getElementById('v-co2')
};
const elS = {
  pm10: document.getElementById('s-pm10'),
  pm25: document.getElementById('s-pm25'),
  co2 : document.getElementById('s-co2')
};
function fmt(key, v){
  if(key==='co2') return `${Math.round(v)}`
  return `${(Math.round(v*10)/10).toFixed(1)}`
}
function setState(key, v){
  const good = v <= thresholds[key];
  const el = elS[key];
  el.textContent = good ? '좋음' : '위험';
  el.className = 'state ' + (good ? 'good':'bad');
}

/* ------------------------------ 차트 ------------------------------ */
let chart;
const baseOptions = {
  responsive:true,
  maintainAspectRatio:false,
  interaction:{ mode:'nearest', intersect:true },
  /* 모바일 탭/터치 이벤트 명시 */
  events:['mousemove','mouseout','click','touchstart','touchmove','pointerdown','pointerup'],
  scales:{
    x:{ ticks:{ color:'#475569', font:{ weight:700 } }, grid:{ color:'rgba(2,6,23,.06)'} },
    y:{ ticks:{ color:'#475569', font:{ weight:800 } }, grid:{ color:'rgba(2,6,23,.06)'} }
  },
  plugins:{
    legend:{ display:false },
    tooltip:{ mode:'nearest', intersect:false }
  }
};
function gradient(ctx, color){
  const g = ctx.createLinearGradient(0,0,0,400);
  g.addColorStop(0, color);
  g.addColorStop(1, 'rgba(14,165,233,0)');
  return g;
}
function openChart(key, title){
  const modal=document.getElementById('modal'); modal.classList.add('show');
  document.getElementById('modal-title').textContent = title;
  const ctx = document.getElementById('chart').getContext('2d');
  chart && chart.destroy();
  const data = hist[key];
  const color = key==='co2' ? 'rgba(234,179,8,.7)' : 'rgba(14,165,233,.75)';
  chart = new Chart(ctx, {
    type:'line',
    data:{
      labels: labels.slice(),
      datasets:[{
        label:title,
        data: data.slice(),
        borderColor: color,
        backgroundColor: gradient(ctx, color.replace('.75','.18')),
        pointRadius: 2, tension:.25, fill:true
      }]
    },
    options: baseOptions
  });
}
document.getElementById('btn-close').onclick=()=>document.getElementById('modal').classList.remove('show');
document.getElementById('modal').addEventListener('click',e=>{
  if(e.target.id==='modal') e.currentTarget.classList.remove('show');
});
document.querySelectorAll('.open-graph').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const key = btn.dataset.key;
    const title = key==='pm10'?'PM10 시간대별 측정값'
                 : key==='pm25'?'PM2.5 시간대별 측정값'
                 : 'CO₂ 시간대별 측정값';
    openChart(key, title);
  }, {passive:true});
});
document.getElementById('btn-graph-all').addEventListener('click', ()=>openChart('pm10','PM10 시간대별 측정값'), {passive:true});

/* ------------------------------ 렌더 + 루프 ------------------------------ */
function render(){
  ['pm10','pm25','co2'].forEach(k=>{
    elV[k].textContent = fmt(k, cur[k]);
    setState(k, cur[k]);
  });
}
function step(pushLabel=true){
  const v1=nextValue('pm10',cur.pm10, 1.2, 12);
  const v2=nextValue('pm25',cur.pm25, 0.7, 5.5);
  const v3=nextValue('co2' ,cur.co2 , 6  , 90);
  hist.pm10.push(v1); hist.pm10.shift();
  hist.pm25.push(v2); hist.pm25.shift();
  hist.co2 .push(v3); hist.co2 .shift();
  if(pushLabel){ labels.push(timeLabel(0)); labels.shift(); }
  render();
  if(chart){ chart.data.labels = labels.slice(); chart.update('none'); }
}
function forceRefresh(){ step(true); } // 외부에서 호출 가능
window.forceRefresh = forceRefresh;

render(); // 초기 표시
/* 30초 간격 업데이트 */
let timer = setInterval(()=>step(true), 30000);

/* 즉시 새로고침 버튼 */
document.getElementById('btn-refresh').onclick = ()=>forceRefresh();

/* 탭 전환 후 복귀 시 한 번 강제 새로고침 */
document.addEventListener('visibilitychange', ()=>{
  if(!document.hidden) forceRefresh();
});

/* iOS 터치 초기화(클릭 인식 보조) */
window.addEventListener('load', ()=>{
  document.querySelectorAll('canvas').forEach(cv=>{
    cv.addEventListener('touchstart', ()=>{}, {passive:true});
  });
});
</script>
</body>
</html>
