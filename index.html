<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>디지털 치유정원 · 실시간 환경 대시보드</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<style>
/* CSS 변수: 폰트/색 대비 유지 */
:root{
  --bg:#071613; --panel: radial-gradient(160% 200% at 50% -40%, #0c241e 0%, #061815 70%);
  --ink:#dff9ef; /* 메인 폰트 색상 */
  --muted:#bfead8; /* 보조 폰트 색상 */
  --good:#22c58b; --ok:#ffd166; --bad:#ff7b7b;
  --cardBorder: rgba(191,234,216,.18); --grid:#123229;
  --chart-text:#bfead8; /* 차트 폰트 색상 (배경과 대비 유지) */
  --chart-grid:rgba(191,234,216,.18); --chart-axis:rgba(191,234,216,.38);
}
*{ box-sizing:border-box }

/* 모바일/데스크톱 안정성 확보를 위한 높이 설정 */
html{height:100%}
body{ margin:0; font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:var(--ink); background:radial-gradient(140% 160% at 50% -30%, #0f2d25 0%, #071613 65%);
  min-height: 100vh; /* 최소 높이 설정 */
}

/* 헤더 */
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:22px 26px 12px}
.title{font-weight:800;letter-spacing:.4px;font-size:34px}
.header__right{display:flex;gap:10px;align-items:center}
.chip-time{color:var(--muted);font-size:14px;opacity:.9}

/* 버튼 */
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;
  border:1px solid rgba(191,234,216,.2);cursor:pointer;background:#0d241d;color:var(--ink);
  font-weight:800;letter-spacing:.2px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
  transition:transform .12s,box-shadow .12s,background .12s}
.btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(0,0,0,.25),inset 0 0 0 1px rgba(255,255,255,.12)}
.btn--primary{background:var(--good);color:#04251b;border-color:transparent}

/* 그리드 */
.grid{padding:10px 22px 18px;display:grid;gap:14px;grid-template-columns:repeat(4,1fr)}

/* 카드 */
.card{position:relative;border:1px solid var(--cardBorder);background:var(--panel);border-radius:16px;
  padding:16px 16px 58px;min-height:170px;box-shadow:0 12px 40px rgba(0,0,0,.3)}
.card__top{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.card__label{display:flex;align-items:center;gap:8px;font-weight:800;letter-spacing:.2px}
.bullet{width:9px;height:9px;border-radius:50%;background:var(--good);box-shadow:0 0 0 3px rgba(34,197,139,.15)}
.badge{font-size:12px;padding:4px 10px;border-radius:999px;font-weight:800;background:#0b2a22;border:1px solid rgba(191,234,216,.18);color:var(--muted)}
.badge--good{background:rgba(34,197,139,.18);color:#22c58b;border-color:rgba(34,197,139,.38)}
.badge--warn{background:rgba(255,209,102,.18);color:#ffd166;border-color:rgba(255,209,102,.38)}
.badge--bad{background:rgba(255,123,123,.18);color:#ff7b7b;border-color:rgba(255,123,123,.38)}

.card__value{font-weight:800;font-size:40px;letter-spacing:.2px;line-height:1.1;margin:8px 0 2px}
.card__unit{color:var(--muted);font-size:14px;margin-left:6px}
.card__hint{color:var(--muted);font-size:12px;margin:4px 0 6px;opacity:.9}

/* ⭐ 스파크라인 고정 영역: 흘러내림(canvas 높이가 커지는 문제) 방지 최종 수정 */
.spark-wrap{height:56px;overflow:hidden; position: relative;} /* 높이 고정 */
.spark{height:100% !important; width:100%; display:block; max-height: 100% !important; min-height: 100% !important; } /* 캔버스 높이 강제 고정 */

/* 그래프 버튼 동작 확인 */
.btn-graph{position:absolute;right:12px;bottom:12px;z-index:2;display:inline-flex;gap:6px;align-items:center;
  background:#22c58b;color:#062a1f;border:0;border-radius:999px;padding:8px 12px;font-size:13px;font-weight:800;
  letter-spacing:.2px;cursor:pointer;box-shadow:0 6px 16px rgba(34,197,139,.25),inset 0 0 0 1px rgba(255,255,255,.18)}
.btn-graph::before{content:"📈"}

/* 모달 공통 */
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:90}
.modal.is-open{display:flex}
.modal__panel{width:min(1200px,92vw);height:min(76vh,900px);background:radial-gradient(120% 140% at 50% 0%,#0e2620 0%,#061815 80%);
  border:1px solid rgba(191,234,216,.2);border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.5);overflow:hidden;display:flex;flex-direction:column}
.modal__bar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(191,234,216,.18);color:#bfead8;font-weight:800}
.modal__close{background:transparent;color:#bfead8;border:0;font-weight:800;cursor:pointer}
/* 모달 차트 컨테이너: flex-1로 모달 크기에 맞춰 유동적으로 높이 확보 */
.modal__canvas-wrap{padding:14px 14px 18px;flex:1;min-height:0}
/* Canvas에 width/height 100% 설정이 중요함 (Chart.js 옵션으로 제어 가능하지만 CSS에서도 보조) */
#detailChart{width:100%;height:100%;display:block}

/* 종합평가 */
.eval-wrap{padding:16px;display:grid;gap:12px;grid-template-columns:repeat(4,1fr);overflow-y:auto} /* 모바일에서 스크롤 가능하도록 overflow-y:auto 추가 */
.eval-card{border:1px solid var(--cardBorder);background:var(--panel);border-radius:14px;padding:16px;display:flex;gap:12px;align-items:center}
.eval-card__title{font-weight:800}
.eval-card__score{margin-left:auto;font-weight:800;flex-shrink:0} /* 점수가 잘리지 않도록 flex-shrink:0 추가 */
.eval-overall{margin:12px 16px 6px;padding:12px 14px;border-radius:12px;border:1px solid var(--cardBorder);background:#0b241e;font-weight:800}

/* 푸터 로고 */
.footer{padding:6px 16px 22px;color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center;justify-content:center}
.footer img{height:18px;opacity:.92}

/* 반응형 레이아웃 개선 */
@media (max-width:1200px){
  .grid{grid-template-columns:repeat(2,1fr)}
  .card__value{font-size:34px}
  .eval-wrap{grid-template-columns:repeat(2,1fr)} /* 태블릿에서 2열 */
}
@media (max-width:680px){
  .header{padding:16px 16px 8px; flex-wrap:wrap} /* 모바일 헤더 */
  .header__right{margin-top:6px; width:100%; justify-content:stretch}
  .header__right .btn{flex:1; justify-content:center}
  .grid{grid-template-columns:1fr; padding:8px 16px 16px}
  .title{font-size:26px}
  .card__value{font-size:30px}
  .eval-wrap{grid-template-columns:1fr} /* 모바일에서 1열 */
  .modal__panel{width:98vw; height:90vh} /* 모바일 모달 크기 조정 */
}
</style>
</head>
<body>

<header class="header">
  <div class="title">디지털 치유정원 · 실시간 환경 대시보드</div>
  <div class="header__right">
    <span class="chip-time" id="timeNote">-</span>
    <button class="btn" id="btnViewMonitor">모니터링</button>
    <button class="btn" id="btnViewEval">종합평가</button>
    <button class="btn btn--primary" id="btnRefresh">지금 새로고침</button>
  </div>
</header>

<main class="grid" id="grid"></main>

<footer class="footer">
  <img alt="국립정원문화원 로고" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMjgwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnIGZvbnQtZmFtaWx5PSJQcmV0ZW5kYXJkLCBzYW5zLXNlcmlmIiBmb250LXdlaWdodD0iODAwIj48cGF0aCBkPSJNMCAyMGM2MC0xMCA5MC0xMCAxNTAuNSAwUzI0MCAzMCAyODAgMjAiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iLjkwIi8+PHRleHQgeD0iMTQiIHk9IjI5IiBmb250LXNpemU9IjE0IiBmaWxsPSIjZmZmIj7qsIDslYjqsJDsnbTqsIQg7ZiE7J6l66m07Yq4PC90ZXh0PjwvZz48L3N2Zz4=" />
  <span>· Healing Garden · Dark Forest UI (single-file)</span>
</footer>

<div id="chartModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal__panel">
    <div class="modal__bar">
      <strong id="chartTitle">상세 그래프</strong>
      <button type="button" class="modal__close" id="closeChart">닫기 ✕</button>
    </div>
    <div class="modal__canvas-wrap"><canvas id="detailChart"></canvas></div>
  </div>
</div>

<div id="evalModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal__panel">
    <div class="modal__bar">
      <strong>종합 평가</strong>
      <button type="button" class="modal__close" id="closeEval">닫기 ✕</button>
    </div>
    <div id="evalOverall" class="eval-overall">종합 상태 계산 중…</div>
    <div class="eval-wrap" id="evalWrap"></div>
  </div>
</div>

<script>
const ITEMS = [
  { key:'pm10', label:'PM10',  unit:'µg/m³', color:'#50f4c2' },
  { key:'pm25', label:'PM2.5', unit:'µg/m³', color:'#5bd6ff' },
  { key:'co2',  label:'CO₂',   unit:'ppm',   color:'#ffe36e' },
  { key:'temp', label:'온도',   unit:'℃',     color:'#ffb386' },
  { key:'hum',  label:'습도',   unit:'%RH',   color:'#b2f1dd' },
  { key:'lux',  label:'조도',   unit:'lux',   color:'#84ffc9' },
  { key:'noise',label:'소음',   unit:'dB',    color:'#a7b8ff' },
  { key:'wind', label:'풍속',   unit:'m/s',   color:'#93f6f2' },
];
function statusOf(key,val){
  switch(key){
    case 'pm10': return val<50 ? '좋음' : (val<100?'주의':'나쁨');
    case 'pm25': return val<25 ? '좋음' : (val<50?'주의':'나쁨');
    case 'co2' : return val<800 ? '좋음' : (val<1200?'주의':'나쁨');
    case 'temp': return (val>=18&&val<=26) ? '좋음' : '주의';
    case 'hum' : return (val>=40&&val<=60) ? '좋음' : '주의';
    case 'lux' : return (val>=200&&val<=800)? '좋음' : '주의';
    case 'noise':return val<60 ? '좋음' : (val<75?'주의':'나쁨');
    case 'wind': return val<5 ? '좋음' : (val<9?'주의':'나쁨');
    default:return '주의';
  }
}
function badgeClass(s){ return s==='좋음' ? 'badge--good' : (s==='주의'?'badge--warn':'badge--bad'); }
function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() }

/* Chart.js 기본 설정: 폰트/색 대비 유지 */
Chart.defaults.font.family = "'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = getCss('--chart-text');
Chart.defaults.plugins.legend.labels.color = Chart.defaults.color;
Chart.defaults.plugins.tooltip.titleColor = '#07241b';
Chart.defaults.plugins.tooltip.bodyColor  = '#07241b';
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(191,234,216,.96)';

/* 스파크라인 설정 최적화: 높이 고정을 위해 maintainAspectRatio:false, aspectRatio:null 설정 */
const sparkOptions = {
  responsive:true, maintainAspectRatio:false, aspectRatio:null, /* 높이 56px 고정 */
  resizeDelay:0,
  animation:false,
  plugins:{ legend:{display:false}, tooltip:{enabled:true, mode:'index', intersect:false} },
  scales:{ x:{display:false}, y:{display:false} },
  elements:{ line:{ borderWidth:2, tension:.35 }, point:{ radius:0, hitRadius:6 } }
};

const historyMap = {};
const sparkCharts = {};
const dom = {
  grid: document.getElementById('grid'),
  timeNote: document.getElementById('timeNote'),
  btnRefresh: document.getElementById('btnRefresh'),
  btnViewEval: document.getElementById('btnViewEval'),
  btnViewMon : document.getElementById('btnViewMonitor'),
  chartModal: document.getElementById('chartModal'),
  chartTitle: document.getElementById('chartTitle'),
  chartClose: document.getElementById('closeChart'),
  detailCanvas: document.getElementById('detailChart'),
  evalModal: document.getElementById('evalModal'),
  evalClose: document.getElementById('closeEval'),
  evalWrap: document.getElementById('evalWrap'),
  evalOverall: document.getElementById('evalOverall'),
};
let detailChart;

function initCards(){
  const frag = document.createDocumentFragment();
  ITEMS.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card__top">
        <div class="card__label"><span class="bullet"></span><span>${it.label}</span></div>
        <span class="badge" id="badge-${it.key}">-</span>
      </div>
      <div>
        <span class="card__value" id="val-${it.key}">-</span><span class="card__
